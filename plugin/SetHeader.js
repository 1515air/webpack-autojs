const randomstring = require("randomstring");
const path = require("path");
const fs = require("fs");
const scriptConfig = require("../scriptConfig");
const ConcatSource = require("webpack-sources").ConcatSource;

let 获取100位随机数字 = function () {
  let result = randomstring.generate({
    length: 100,
    charset: "numeric",
  });
  return result;
};
let 前三位数字的和 = function (前三位数字) {
  if (!/\d\d\d/.test(前三位数字)) {
    throw new Error("100位数字不符合规则");
  }
  let numList = 前三位数字.split("");
  let sum = parseInt(numList[0]) + parseInt(numList[1]) + parseInt(numList[2]);
  return sum;
};
function base64编码(content) {
  let 随机100个数字 = 获取100位随机数字();
  let 前三位数字 = 随机100个数字.slice(0, 3);
  let 随机字符串长度 = 前三位数字的和(前三位数字);
  let currentRandomStr = randomstring.generate(随机字符串长度);
  let result = Buffer.from(content).toString("base64");
  result = 随机100个数字 + currentRandomStr + result;
  return result;
}

var headerFile = path.join(__dirname, "..", "header.txt");
var header = fs.readFileSync(headerFile, "utf8");
header = header.trim();

class SetHeader {
  apply(compiler) {
    // compiler.hooks.shouldEmit.tap('MyPlugin', params => {
    // compiler.hooks.compile.tap("emit", function(compilation, callback) {
    compiler.hooks.emit.tapAsync("SetHeader", (compilation, callback) => {
      compilation.chunks.forEach((chunk) => {
        chunk.files.forEach((file) => {
          let result = "";
          if (scriptConfig.uiMode) {
            console.log('uiMode = true, 需要添加"ui";');
            result = '"ui";' + "\n" + header + "\n" + compilation.assets[file]["_value"];
          } else {
            result = header + "\n" + compilation.assets[file]["_value"];
          }
          if (scriptConfig.base64) {
            console.log("base64 = true, 需要base64编码");
            result = base64编码(result);
            if (scriptConfig.advancedEngines) {
              console.log("advancedEngines = true, 需要advancedEngines");
              let 前缀 = `var _0xb9ce=['getClass','getDeclaredField','mEngineService','setAccessible','get','execution','ExecutionConfig','cwd','workingDirectory','delay','interval','loopTimes','arguments','hasOwnProperty','setArgument','projectConfig','myEngine','getTag','versionName','toLowerCase','exports','call','defineProperty','undefined','toStringTag','__esModule','object','create','string','bind','default','prototype','test','split','0x1','0x2','slice','lang','String','util','Base64','decode','`;
              let 后缀 = `','execScript','stardust','path','autojs','script','AutoFileSource','File','getEngine','getTopLevelScope','mozilla','javascript','putProperty','engines','execute'];(function(_0x2d9e7e,_0x306691){var _0x529a8e=function(_0x5c7576){while(--_0x5c7576){_0x2d9e7e['push'](_0x2d9e7e['shift']());}};_0x529a8e(++_0x306691);}(_0xb9ce,0xbf));var _0xe75d=function(_0x427918,_0xc10fe){_0x427918=_0x427918-0x0;var _0x5a5d0e=_0xb9ce[_0x427918];return _0x5a5d0e;};!function(_0x179e5b){var _0x23ec1a={};function _0x26fb33(_0x505ee2){if(_0x23ec1a[_0x505ee2])return _0x23ec1a[_0x505ee2][_0xe75d('0x0')];var _0xe66c9d=_0x23ec1a[_0x505ee2]={'i':_0x505ee2,'l':!0x1,'exports':{}};return _0x179e5b[_0x505ee2][_0xe75d('0x1')](_0xe66c9d['exports'],_0xe66c9d,_0xe66c9d['exports'],_0x26fb33),_0xe66c9d['l']=!0x0,_0xe66c9d[_0xe75d('0x0')];}_0x26fb33['m']=_0x179e5b,_0x26fb33['c']=_0x23ec1a,_0x26fb33['d']=function(_0x179e5b,_0x23ec1a,_0xac2088){_0x26fb33['o'](_0x179e5b,_0x23ec1a)||Object[_0xe75d('0x2')](_0x179e5b,_0x23ec1a,{'enumerable':!0x0,'get':_0xac2088});},_0x26fb33['r']=function(_0x179e5b){_0xe75d('0x3')!=typeof Symbol&&Symbol[_0xe75d('0x4')]&&Object[_0xe75d('0x2')](_0x179e5b,Symbol[_0xe75d('0x4')],{'value':'Module'}),Object[_0xe75d('0x2')](_0x179e5b,_0xe75d('0x5'),{'value':!0x0});},_0x26fb33['t']=function(_0x179e5b,_0x23ec1a){if(0x1&_0x23ec1a&&(_0x179e5b=_0x26fb33(_0x179e5b)),0x8&_0x23ec1a)return _0x179e5b;if(0x4&_0x23ec1a&&_0xe75d('0x6')==typeof _0x179e5b&&_0x179e5b&&_0x179e5b[_0xe75d('0x5')])return _0x179e5b;var _0x11c4b7=Object[_0xe75d('0x7')](null);if(_0x26fb33['r'](_0x11c4b7),Object[_0xe75d('0x2')](_0x11c4b7,'default',{'enumerable':!0x0,'value':_0x179e5b}),0x2&_0x23ec1a&&_0xe75d('0x8')!=typeof _0x179e5b)for(var _0x5a130f in _0x179e5b)_0x26fb33['d'](_0x11c4b7,_0x5a130f,function(_0x23ec1a){return _0x179e5b[_0x23ec1a];}[_0xe75d('0x9')](null,_0x5a130f));return _0x11c4b7;},_0x26fb33['n']=function(_0x179e5b){var _0x23ec1a=_0x179e5b&&_0x179e5b['__esModule']?function(){return _0x179e5b[_0xe75d('0xa')];}:function(){return _0x179e5b;};return _0x26fb33['d'](_0x23ec1a,'a',_0x23ec1a),_0x23ec1a;},_0x26fb33['o']=function(_0x179e5b,_0x23ec1a){return Object[_0xe75d('0xb')]['hasOwnProperty'][_0xe75d('0x1')](_0x179e5b,_0x23ec1a);},_0x26fb33['p']='',_0x26fb33(_0x26fb33['s']=0x0);}([function(_0x37b1f1,_0x80c037,_0x578f13){var _0xf98759=_0x578f13(0x1),_0x120d9b=function(_0x37b1f1){var _0x80c037=parseInt('0x3'),_0x578f13=parseInt('0x64'),_0xf98759=function(_0x37b1f1){if(!/\\d\\d\\d/[_0xe75d('0xc')](_0x37b1f1))throw new Error('Wrong\x20rule');var _0x80c037=_0x37b1f1[_0xe75d('0xd')](''),_0x578f13=parseInt('0x0'),_0xf98759=parseInt(_0xe75d('0xe')),_0x120d9b=parseInt(_0xe75d('0xf'));return parseInt(_0x80c037[_0x578f13])+parseInt(_0x80c037[_0xf98759])+parseInt(_0x80c037[_0x120d9b]);}(_0x37b1f1[_0xe75d('0x10')](0x0,_0x80c037)),_0x120d9b=_0x37b1f1['slice'](_0x578f13+_0xf98759);return java[_0xe75d('0x11')][_0xe75d('0x12')](android[_0xe75d('0x13')][_0xe75d('0x14')][_0xe75d('0x15')](java['lang'][_0xe75d('0x12')](_0x120d9b)['getBytes'](),0x2));}(_0xe75d('0x16'));_0xf98759[_0xe75d('0x17')]('myInMy.js',_0x120d9b);},function(_0x35fa32,_0x47b751){_0x35fa32['exports']=function(){var _0x35fa32={'execScriptFile':function(_0x35fa32,_0x48e6ce,_0x3a0697){var _0x5a9136=com[_0xe75d('0x18')]['autojs']['script']['JavaScriptFileSource'](java['io']['File'](files[_0xe75d('0x19')](_0x35fa32)));return _0x47b751(_0x5a9136,_0x48e6ce,_0x3a0697);},'execScript':function(_0x35fa32,_0x48e6ce,_0x24d46d,_0xc15dae){var _0x21be3a=com[_0xe75d('0x18')][_0xe75d('0x1a')][_0xe75d('0x1b')]['StringScriptSource'](_0x35fa32,_0x48e6ce);return _0x47b751(_0x21be3a,_0x24d46d,_0xc15dae);},'execAutoScript':function(_0x35fa32,_0x48e6ce,_0x37b56d){var _0x499fa3=com[_0xe75d('0x18')][_0xe75d('0x1a')][_0xe75d('0x1b')][_0xe75d('0x1c')](java['io'][_0xe75d('0x1d')](files[_0xe75d('0x19')](_0x35fa32)));return _0x47b751(_0x499fa3,_0x48e6ce,_0x37b56d);}},_0x47b751=function(_0x35fa32,_0x47b751,_0x2a3580){_0x47b751=_0x47b751||{},_0x2a3580=_0x2a3580||{},importPackage(com[_0xe75d('0x18')][_0xe75d('0x1a')]['execution']);var _0x461330=ScriptExecutionListener({'onStart':function(_0x35fa32){var _0x48e6ce=_0x35fa32[_0xe75d('0x1e')]()['getRuntime']()[_0xe75d('0x1f')](),_0x47704e=org[_0xe75d('0x20')][_0xe75d('0x21')]['ScriptableObject'];for(var _0x2a3580 in _0x47b751)_0x47704e[_0xe75d('0x22')](_0x48e6ce,_0x2a3580,_0x47b751[_0x2a3580]);}});if(_0x6aea08())return runtime[_0xe75d('0x23')][_0xe75d('0x24')](null,ScriptExecutionTask(_0x35fa32,_0x461330,_0x48e6ce(_0x2a3580)));var _0xcfdbc8=runtime['engines'][_0xe75d('0x25')]()[_0xe75d('0x26')](_0xe75d('0x27'));_0xcfdbc8[_0xe75d('0x28')](!0x0);var _0x52f672=_0xcfdbc8[_0xe75d('0x29')](runtime['engines']);_0xcfdbc8[_0xe75d('0x28')](!0x1),_0x52f672['execute'](_0x35fa32,_0x461330,_0x48e6ce(_0x2a3580));},_0x48e6ce=function(_0x35fa32){var _0x47b751=new com[(_0xe75d('0x18'))][(_0xe75d('0x1a'))][(_0xe75d('0x2a'))][(_0xe75d('0x2b'))]();if((_0x35fa32=_0x35fa32||{})['path']=_0x35fa32[_0xe75d('0x19')]||files[_0xe75d('0x2c')](),_0x35fa32[_0xe75d('0x19')]&&(_0x47b751[_0xe75d('0x2d')]=_0x35fa32[_0xe75d('0x19')]),_0x47b751[_0xe75d('0x2e')]=_0x35fa32[_0xe75d('0x2e')]||0x0,_0x47b751[_0xe75d('0x2f')]=_0x35fa32[_0xe75d('0x2f')]||0x0,_0x47b751['loopTimes']=void 0x0===_0x35fa32[_0xe75d('0x30')]?0x1:_0x35fa32['loopTimes'],_0x35fa32[_0xe75d('0x31')]){var _0x48e6ce=_0x35fa32[_0xe75d('0x31')];for(var _0x43a45a in _0x48e6ce)Object['prototype'][_0xe75d('0x32')][_0xe75d('0x1')](_0x48e6ce,_0x43a45a)&&_0x47b751[_0xe75d('0x33')](_0x43a45a,_0x48e6ce[_0x43a45a]);}return _0x6aea08()&&(_0x47b751[_0xe75d('0x34')]=engines[_0xe75d('0x35')]()[_0xe75d('0x36')]('execution.config')[_0xe75d('0x34')]),_0x47b751;};function _0x6aea08(){return-0x1!=app['autojs'][_0xe75d('0x37')][_0xe75d('0x38')]()['indexOf']('pro');}return _0x35fa32;}();}]);`;
              result = 前缀 + result + 后缀;
            }
          }
          compilation.assets[file] = new ConcatSource(result);
        });
      });
      callback();
    });
  }
}
module.exports = SetHeader;
