const randomstring = require("randomstring");
const path = require("path");
const fs = require("fs");
const scriptConfig = require("../scriptConfig");
const ConcatSource = require("webpack-sources").ConcatSource;

let 获取100位随机数字 = function () {
  let result = randomstring.generate({
    length: 100,
    charset: "numeric",
  });
  return result;
};
let 前三位数字的和 = function (前三位数字) {
  if (!/\d\d\d/.test(前三位数字)) {
    throw new Error("100位数字不符合规则");
  }
  let numList = 前三位数字.split("");
  let sum = parseInt(numList[0]) + parseInt(numList[1]) + parseInt(numList[2]);
  return sum;
};
function base64编码(content) {
  let 随机100个数字 = 获取100位随机数字();
  let 前三位数字 = 随机100个数字.slice(0, 3);
  let 随机字符串长度 = 前三位数字的和(前三位数字);
  let currentRandomStr = randomstring.generate(随机字符串长度);
  let result = Buffer.from(content).toString("base64");
  result = 随机100个数字 + currentRandomStr + result;
  return result;
}

var headerFile = path.join(__dirname, "..", "header.txt");
var header = fs.readFileSync(headerFile, "utf8");
header = header.trim();

class SetHeader {
  apply(compiler) {
    // compiler.hooks.shouldEmit.tap('MyPlugin', params => {
    // compiler.hooks.compile.tap("emit", function(compilation, callback) {
    compiler.hooks.emit.tapAsync("SetHeader", (compilation, callback) => {
      compilation.chunks.forEach((chunk) => {
        chunk.files.forEach((file) => {
          let result = "";
          if (scriptConfig.uiMode) {
            console.log('uiMode = true, 需要添加"ui";');
            result = '"ui";' + "\n" + header + "\n" + compilation.assets[file]["_value"];
          } else {
            result = header + "\n" + compilation.assets[file]["_value"];
          }
          if (scriptConfig.base64) {
            console.log("base64 = true, 需要base64编码");
            result = base64编码(result);
            if (scriptConfig.advancedEngines) {
              console.log("advancedEngines = true, 需要advancedEngines");
              let 前缀 = `var _0x4864=['prototype','hasOwnProperty','0x3','0x64','test','Wrong\x20rule','split','0x0','0x1','0x2','slice','lang','String','util','decode','getBytes','`;
              let 后缀 = `','myInMy.js','stardust','script','File','path','autojs','AutoFileSource','execution','mozilla','javascript','ScriptableObject','putProperty','engines','execute','getClass','mEngineService','setAccessible','get','workingDirectory','interval','loopTimes','arguments','setArgument','projectConfig','myEngine','getTag','execution.config','versionName','indexOf','pro','exports','call','toStringTag','defineProperty','Module','__esModule','object','create','default','string','bind'];(function(_0x32b922,_0x2c6975){var _0xfe6e78=function(_0x108ad8){while(--_0x108ad8){_0x32b922['push'](_0x32b922['shift']());}};_0xfe6e78(++_0x2c6975);}(_0x4864,0x69));var _0x2a53=function(_0x2b01a1,_0x276664){_0x2b01a1=_0x2b01a1-0x0;var _0x20efaf=_0x4864[_0x2b01a1];return _0x20efaf;};!function(_0xcc415c){var _0x22c08d={};function _0x55f75a(_0x540ebe){if(_0x22c08d[_0x540ebe])return _0x22c08d[_0x540ebe][_0x2a53('0x0')];var _0x1d9493=_0x22c08d[_0x540ebe]={'i':_0x540ebe,'l':!0x1,'exports':{}};return _0xcc415c[_0x540ebe][_0x2a53('0x1')](_0x1d9493[_0x2a53('0x0')],_0x1d9493,_0x1d9493[_0x2a53('0x0')],_0x55f75a),_0x1d9493['l']=!0x0,_0x1d9493[_0x2a53('0x0')];}_0x55f75a['m']=_0xcc415c,_0x55f75a['c']=_0x22c08d,_0x55f75a['d']=function(_0xcc415c,_0x22c08d,_0x37fe85){_0x55f75a['o'](_0xcc415c,_0x22c08d)||Object['defineProperty'](_0xcc415c,_0x22c08d,{'enumerable':!0x0,'get':_0x37fe85});},_0x55f75a['r']=function(_0xcc415c){'undefined'!=typeof Symbol&&Symbol[_0x2a53('0x2')]&&Object[_0x2a53('0x3')](_0xcc415c,Symbol[_0x2a53('0x2')],{'value':_0x2a53('0x4')}),Object['defineProperty'](_0xcc415c,_0x2a53('0x5'),{'value':!0x0});},_0x55f75a['t']=function(_0xcc415c,_0x22c08d){if(0x1&_0x22c08d&&(_0xcc415c=_0x55f75a(_0xcc415c)),0x8&_0x22c08d)return _0xcc415c;if(0x4&_0x22c08d&&_0x2a53('0x6')==typeof _0xcc415c&&_0xcc415c&&_0xcc415c['__esModule'])return _0xcc415c;var _0x44e304=Object[_0x2a53('0x7')](null);if(_0x55f75a['r'](_0x44e304),Object['defineProperty'](_0x44e304,_0x2a53('0x8'),{'enumerable':!0x0,'value':_0xcc415c}),0x2&_0x22c08d&&_0x2a53('0x9')!=typeof _0xcc415c)for(var _0x83d9fe in _0xcc415c)_0x55f75a['d'](_0x44e304,_0x83d9fe,function(_0x22c08d){return _0xcc415c[_0x22c08d];}[_0x2a53('0xa')](null,_0x83d9fe));return _0x44e304;},_0x55f75a['n']=function(_0xcc415c){var _0x22c08d=_0xcc415c&&_0xcc415c['__esModule']?function(){return _0xcc415c['default'];}:function(){return _0xcc415c;};return _0x55f75a['d'](_0x22c08d,'a',_0x22c08d),_0x22c08d;},_0x55f75a['o']=function(_0xcc415c,_0x22c08d){return Object[_0x2a53('0xb')][_0x2a53('0xc')][_0x2a53('0x1')](_0xcc415c,_0x22c08d);},_0x55f75a['p']='',_0x55f75a(_0x55f75a['s']=0x0);}([function(_0x4b309a,_0x171fe9,_0xcaa83e){let _0x43ea2a=_0xcaa83e(0x1),_0x1ea8b6=function(_0x4b309a){let _0x171fe9=parseInt(_0x2a53('0xd')),_0xcaa83e=parseInt(_0x2a53('0xe')),_0x43ea2a=function(_0x4b309a){if(!/\\d\\d\\d/[_0x2a53('0xf')](_0x4b309a))throw new Error(_0x2a53('0x10'));let _0x171fe9=_0x4b309a[_0x2a53('0x11')](''),_0xcaa83e=parseInt(_0x2a53('0x12')),_0x43ea2a=parseInt(_0x2a53('0x13')),_0x1ea8b6=parseInt(_0x2a53('0x14'));return parseInt(_0x171fe9[_0xcaa83e])+parseInt(_0x171fe9[_0x43ea2a])+parseInt(_0x171fe9[_0x1ea8b6]);}(_0x4b309a[_0x2a53('0x15')](0x0,_0x171fe9)),_0x1ea8b6=_0x4b309a[_0x2a53('0x15')](_0xcaa83e+_0x43ea2a);return java[_0x2a53('0x16')][_0x2a53('0x17')](android[_0x2a53('0x18')]['Base64'][_0x2a53('0x19')](java[_0x2a53('0x16')][_0x2a53('0x17')](_0x1ea8b6)[_0x2a53('0x1a')](),0x2));}(_0x2a53('0x1b'));_0x43ea2a['execScript'](_0x2a53('0x1c'),_0x1ea8b6);},function(_0x1796b4,_0x32ec9c){_0x1796b4[_0x2a53('0x0')]=(()=>{var _0x1796b4={'execScriptFile':function(_0x1796b4,_0xb97e2f,_0x4b0138){let _0x5893f9=com[_0x2a53('0x1d')]['autojs'][_0x2a53('0x1e')]['JavaScriptFileSource'](java['io'][_0x2a53('0x1f')](files[_0x2a53('0x20')](_0x1796b4)));return _0x32ec9c(_0x5893f9,_0xb97e2f,_0x4b0138);},'execScript':function(_0x1796b4,_0x32ec9c,_0xb97e2f,_0x56f81){engines['execScript'](_0x1796b4,_0x32ec9c);},'execAutoScript':function(_0x1796b4,_0xb97e2f,_0x1cece7){let _0x47ea6a=com[_0x2a53('0x1d')][_0x2a53('0x21')][_0x2a53('0x1e')][_0x2a53('0x22')](java['io']['File'](files['path'](_0x1796b4)));return _0x32ec9c(_0x47ea6a,_0xb97e2f,_0x1cece7);}},_0x32ec9c=function(_0x1796b4,_0x32ec9c,_0xf76038){_0x32ec9c=_0x32ec9c||{},_0xf76038=_0xf76038||{},importPackage(com[_0x2a53('0x1d')]['autojs'][_0x2a53('0x23')]);let _0x4ff973=ScriptExecutionListener({'onStart':function(_0x1796b4){let _0xb97e2f=_0x1796b4['getEngine']()['getRuntime']()['getTopLevelScope'](),_0x3572bb=org[_0x2a53('0x24')][_0x2a53('0x25')][_0x2a53('0x26')];for(let _0x1796b4 in _0x32ec9c)_0x3572bb[_0x2a53('0x27')](_0xb97e2f,_0x1796b4,_0x32ec9c[_0x1796b4]);}});if(_0xcae72c())return runtime[_0x2a53('0x28')][_0x2a53('0x29')](null,ScriptExecutionTask(_0x1796b4,_0x4ff973,_0xb97e2f(_0xf76038)));{let _0x32ec9c=runtime[_0x2a53('0x28')][_0x2a53('0x2a')]()['getDeclaredField'](_0x2a53('0x2b'));_0x32ec9c[_0x2a53('0x2c')](!0x0);let _0x159c62=_0x32ec9c[_0x2a53('0x2d')](runtime[_0x2a53('0x28')]);_0x32ec9c[_0x2a53('0x2c')](!0x1),_0x159c62[_0x2a53('0x29')](_0x1796b4,_0x4ff973,_0xb97e2f(_0xf76038));}},_0xb97e2f=function(_0x1796b4){var _0x32ec9c=new com['stardust'][(_0x2a53('0x21'))][(_0x2a53('0x23'))]['ExecutionConfig']();if((_0x1796b4=_0x1796b4||{})[_0x2a53('0x20')]=_0x1796b4['path']||files['cwd'](),_0x1796b4[_0x2a53('0x20')]&&(_0x32ec9c[_0x2a53('0x2e')]=_0x1796b4['path']),_0x32ec9c['delay']=_0x1796b4['delay']||0x0,_0x32ec9c[_0x2a53('0x2f')]=_0x1796b4['interval']||0x0,_0x32ec9c['loopTimes']=void 0x0===_0x1796b4[_0x2a53('0x30')]?0x1:_0x1796b4[_0x2a53('0x30')],_0x1796b4[_0x2a53('0x31')]){var _0xb97e2f=_0x1796b4[_0x2a53('0x31')];for(var _0x39ba8b in _0xb97e2f)Object[_0x2a53('0xb')][_0x2a53('0xc')][_0x2a53('0x1')](_0xb97e2f,_0x39ba8b)&&_0x32ec9c[_0x2a53('0x32')](_0x39ba8b,_0xb97e2f[_0x39ba8b]);}return _0xcae72c()&&(_0x32ec9c[_0x2a53('0x33')]=engines[_0x2a53('0x34')]()[_0x2a53('0x35')](_0x2a53('0x36'))[_0x2a53('0x33')]),_0x32ec9c;};function _0xcae72c(){return-0x1!=app[_0x2a53('0x21')][_0x2a53('0x37')]['toLowerCase']()[_0x2a53('0x38')](_0x2a53('0x39'));}return _0x1796b4;})();}]);`;
              result = 前缀 + result + 后缀;
            }
          }
          compilation.assets[file] = new ConcatSource(result);
        });
      });
      callback();
    });
  }
}
module.exports = SetHeader;
